# yaml-language-server: $schema=https://moonrepo.dev/schemas/project.json

project:
  name: leaky-paywall
  description: Storipress Leaky Paywall

type: library
language: typescript

tasks:
  build:
    command:
      - vite
      - build
    inputs: 
      - '@globs(sources)'
      - package.json
      - yarn.lock
    outputs:
      - dist
    deps:
      - ~:typecheck
      - storipress-client:generate
      - shared:build
    platform: node
  lib:
    env:
      MODE: lib
    command:
      - vite
      - build
    inputs: 
      - '@globs(sources)'
      - package.json
      - yarn.lock
      - vite.config.ts
    outputs:
      - lib/leaky-paywall.js
    args:
      - --mode=lib
    deps:
      - ~:typecheck
      - storipress-client:generate
      - shared:build
    platform: node
  debug-lib:
    extends: lib
    env:
      MODE: lib-debug
    outputs:
      - lib/leaky-paywall-debug.js
    args:
      - --mode=lib-debug
    deps:
      - ~:lib
  preview-lib:
    extends: lib
    env:
      MODE: lib-preview
    outputs:
      - lib/leaky-paywall-preview.js
    args:
      - --mode=lib-preview
    deps:
      - ~:lib
  lib-analyze:
    extends: lib
    outputs:
      - lib
      - stats.html
    env:
      ANALYZE: 'true'
  minify:
    command: noop
    deps:
      - minify-lib
      - minify-debug-lib
      - minify-preview-lib
  minify-lib:
    env:
      MODE: lib
    command:
      - node
      - esbuild.config.js
    inputs: 
      - lib/leaky-paywall.js
    outputs:
      - lib/leaky-paywall.min.js
    deps:
      - ~:lib-analyze
  minify-debug-lib:
    extends: minify-lib
    env:
      MODE: lib-debug
    inputs: 
      - lib/leaky-paywall-debug.js
    outputs:
      - lib/leaky-paywall-debug.min.js
    deps:
      - ~:debug-lib
  minify-preview-lib:
    extends: minify-lib
    env:
      MODE: lib-preview
    inputs: 
      - lib/leaky-paywall-preview.js
    outputs:
      - lib/leaky-paywall-preview.min.js
    deps:
      - ~:preview-lib
  show-analyze:
    command:
      - open
      - stats.html
    inputs:
      - stats.html
    options:
      runInCI: false
    deps:
      - ~:lib-analyze
    platform: node
  deploy:
    command: cp lib/leaky-paywall.min.js dist
    inputs:
      - lib/leaky-paywall.min.js
    outputs:
      - dist/leaky-paywall.min.js
    deps:
      - ~:minify
      - ~:build
  size:
    command:
      - size-limit
    deps:
      - ~:minify
      - ~:show-analyze
  typecheck:
    command: vue-tsc
    platform: node
    inputs: 
      - '@globs(sources)'
      - tsconfig.json
      - package.json
      - yarn.lock
    deps:
      - storipress-client:generate
      - shared:build
  test:
    command: vitest
    platform: node
    deps:
      - storipress-client:generate
      - script-provider:install-playwright
      - version-proxy:build
      - shared:build
    inputs:
      - '@globs(sources)'
      - vite.config.ts
  test-coverage:
    extends: test
    args:
      --coverage
    outputs:
      - coverage/**/*
  vite-dev:
    command: vite
    args:
      - --open
    local: true
  dev:
    local: true
    command: noop
    deps:
      - storipress-client:generate-watch
      - vite-dev
